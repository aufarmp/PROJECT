name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-deb:
    runs-on: [deb-laptop]

    steps:
      # Step 0: Find your project folder automatically
      - name: Set project path
        run: |
          PROJECT_PATH=$(find /home -name 'Project-Group-1---Webcomic' -type d 2>/dev/null | head -1)
          if [ -z "$PROJECT_PATH" ]; then
            echo "❌ Error: Folder Project-Group-1---Webcomic tidak ditemukan!"
            exit 1
          fi
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
          echo "✅ Found project at: $PROJECT_PATH"

      # Step 1: Pull latest changes
      - name: Pull latest changes
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          git fetch origin master
          git reset --hard origin/master

      # Step 2: Stop existing containers
      - name: Stop existing containers
        working-directory: ${{ env.PROJECT_PATH }}
        run: docker compose down || true

      # Step 3: Remove old images
      - name: Remove old images
        run: |
          docker system prune -f
          docker image prune -a -f

      # Step 4: Build and start the app
      - name: Build and start containers
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose build --no-cache
          docker compose up -d

      # Step 5: Wait for services
      - name: Wait for services
        run: |
          sleep 30
          docker compose ps

      # Step 6: Health check
      - name: Health check
        run: curl -f http://localhost:8080 || exit 1

      # Step 7: Deployment result
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment berhasil di laptop-deb!"
          else
            echo "❌ Deployment gagal! Cek log."
          fi